name: ADA Compliance Check and Fix

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'force-app/main/default/lwc/**'
      - 'force-app/main/default/aura/**'
      - 'force-app/main/default/components/**'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ada-compliance:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for package.json and install dependencies
        run: |
          if [ -f "package.json" ]; then
            echo "Found package.json, installing project dependencies..."
            npm install
          else
            echo "No package.json found, skipping project dependencies..."
          fi

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files in the PR, excluding .github directory
          git fetch origin main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.(js|ts|html|css)$' | grep -E '(lwc|aura|components)/' | grep -v '^\.github/' || true)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Run ADA Compliance Check and Fix
        if: steps.changed-files.outputs.changed_files != ''
        run: |
          chmod +x .github/scripts/ada-compliance-fix.sh
          .github/scripts/ada-compliance-fix.sh "${{ steps.changed-files.outputs.changed_files }}"

      - name: Format fixed files with Prettier
        if: steps.changed-files.outputs.changed_files != ''
        run: |
          # Run prettier on the modified files to ensure proper formatting
          if [ -f "package.json" ]; then
            npm run prettier || echo "Prettier formatting completed with warnings"
          fi

      - name: Check for changes
        id: verify-changed-files
        run: |
          # Only check for changes in component files, not .github
          if git diff --name-only | grep -E '(force-app|lwc|aura|components)' > /dev/null 2>&1; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit ADA fixes
        if: steps.verify-changed-files.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Only add component files, exclude .github directory
          git add force-app/ || true
          git add --ignore-errors *.html *.js *.css *.ts || true
          
          # Check if there are actually files to commit
          if git diff --staged --quiet; then
            echo "No component files to commit"
            exit 0
          fi
          
          # Bypass pre-commit hooks for ADA fixes
          git commit -m "ðŸ”§ Auto-fix ADA compliance issues

          - Applied accessibility improvements using automated fixes
          - Fixed ARIA attributes, alt text, keyboard navigation, and color contrast
          - Ensured WCAG 2.1 AA compliance standards" --no-verify

      - name: Push changes
        if: steps.verify-changed-files.outputs.changes == 'true'
        run: |
          git push origin ${{ github.head_ref }}

      - name: Comment on PR
        if: steps.verify-changed-files.outputs.changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– **ADA Compliance Auto-Fix Applied**\n\nGitHub Copilot CLI has automatically scanned and fixed accessibility issues in your Salesforce components:\n\nâœ… ARIA attributes optimized\nâœ… Alt text for images added/improved\nâœ… Keyboard navigation enhanced\nâœ… Color contrast issues addressed\nâœ… Screen reader compatibility improved\n\nPlease review the changes and test the accessibility improvements.'
            })

      - name: Create ADA compliance report
        if: always()
        run: |
          echo "# ADA Compliance Report" > ada-report.md
          echo "Generated on: $(date)" >> ada-report.md
          echo "" >> ada-report.md
          echo "## Files Scanned" >> ada-report.md
          echo "${{ steps.changed-files.outputs.changed_files }}" >> ada-report.md
          echo "" >> ada-report.md
          echo "## Status" >> ada-report.md
          if [ "${{ steps.verify-changed-files.outputs.changes }}" == "true" ]; then
            echo "âœ… ADA fixes applied automatically" >> ada-report.md
          else
            echo "âœ… No ADA issues found or all files already compliant" >> ada-report.md
          fi

      - name: Upload ADA report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ada-compliance-report
          path: ada-report.md